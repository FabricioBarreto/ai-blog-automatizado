---
import '../styles/global.css';
import { SITE_TITLE, GOOGLE_ANALYTICS_ID } from '../consts';
import GoogleAdSense from './GoogleAdSense.astro';
import GoogleAnalytics from './GoogleAnalytics.astro';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  pubDate?: string;
  author?: string;
  tags?: string[];
}

const { 
  title, 
  description, 
  image = '/images/default-hero.jpg', 
  type = 'website',
  pubDate,
  author = 'Fabricio Barreto',
  tags = []
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const imageURL = new URL(image, Astro.site);

// Schema Markup para Artículos
const articleSchema = type === 'article' && pubDate ? {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": title,
  "description": description,
  "image": imageURL.toString(),
  "datePublished": pubDate,
  "dateModified": pubDate,
  "author": {
    "@type": "Person",
    "name": author,
    "url": "https://www.productivitylab.online/about"
  },
  "publisher": {
    "@type": "Organization",
    "name": "ProductivityLab",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.productivitylab.online/favicon.svg"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": canonicalURL.toString()
  },
  "keywords": tags.join(', ')
} : null;

// Breadcrumbs Schema
const pathSegments = Astro.url.pathname.split('/').filter(Boolean);
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": Astro.site?.toString()
    },
    ...pathSegments.map((segment, index) => ({
      "@type": "ListItem",
      "position": index + 2,
      "name": segment.replace(/-/g, ' ').replace(/^\d{4}-\d{2}-\d{2}-/, ''),
      "item": new URL(pathSegments.slice(0, index + 1).join('/'), Astro.site).toString()
    }))
  ]
};

// Website Schema (para homepage)
const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": SITE_TITLE,
  "url": Astro.site?.toString(),
  "description": "Blog de IA y productividad en español",
  "potentialAction": {
    "@type": "SearchAction",
    "target": {
      "@type": "EntryPoint",
      "urlTemplate": `${Astro.site}blog?q={search_term_string}`
    },
    "query-input": "required name=search_term_string"
  }
};
---

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

<!-- Preconnect para performance -->
<link rel="preconnect" href="https://res.cloudinary.com" />
<link rel="preconnect" href="https://www.google-analytics.com" />
<link rel="preconnect" href="https://pagead2.googlesyndication.com" />
<link rel="dns-prefetch" href="https://fonts.googleapis.com" />

<link rel="alternate" type="application/rss+xml" title={SITE_TITLE} href={new URL('rss.xml', Astro.site)} />
<meta name="generator" content={Astro.generator} />
<link rel="canonical" href={canonicalURL} />

<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="author" content={author} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={type} />
<meta property="og:url" content={canonicalURL} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={imageURL} />
<meta property="og:site_name" content={SITE_TITLE} />
<meta property="og:locale" content="es_AR" />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalURL} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={imageURL} />

<!-- Google Verification -->
<meta name="google-site-verification" content="9M_tP8B4VOyllMcKtW6z12_AWl_aCDEC4ICVrpcN1I4" />
<meta name="google-adsense-account" content="ca-pub-7615595008514947" />

<!-- Schema Markup JSON-LD -->
{articleSchema && (
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />
)}
<script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
{type === 'website' && (
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
)}

{GOOGLE_ANALYTICS_ID && (
  <script is:inline>
    window.__GA_ID = "{GOOGLE_ANALYTICS_ID}";
  </script>
)}

<GoogleAnalytics />
<GoogleAdSense />