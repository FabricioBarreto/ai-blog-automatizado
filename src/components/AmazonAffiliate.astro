---
interface Props {
  asin: string;
  variant?: 'card' | 'button' | 'full'; // full = card + specs + CTA
  position?: string; // Para tracking: "top", "middle", "bottom"
}

const { asin, variant = 'card', position = 'middle' } = Astro.props;

// Configuraci√≥n de productos (hardcodeado o desde config)
import { AFFILIATE_PRODUCTS } from '../config/products';

const product = AFFILIATE_PRODUCTS[asin];
if (!product) {
  console.warn(`‚ö†Ô∏è Producto no encontrado: ${asin}`);
}

const affiliateTag = 'productivi0d7-20'; // Cambi√° esto por tu tag de Amazon Associates
const amazonUrl = `https://www.amazon.com/dp/${asin}?tag=${affiliateTag}`;

// Para tracking
const trackingId = `amazon-${asin}-${position}`;
---

{product && (
  <div class="amazon-affiliate" data-product-id={asin} data-position={position}>
    
    {variant === 'button' && (
      <a 
        href={amazonUrl} 
        target="_blank" 
        rel="noopener noreferrer sponsored"
        class="amazon-btn"
        data-track-click={trackingId}
      >
        üõí Ver en Amazon - {product.price}
      </a>
    )}

    {variant === 'card' && (
      <div class="product-card">
        <div class="product-header">
          <h4>{product.name}</h4>
          <div class="rating">
            {'‚≠ê'.repeat(Math.floor(product.rating))} {product.rating}
          </div>
        </div>
        <p class="price">{product.price}</p>
        <a 
          href={amazonUrl} 
          target="_blank" 
          rel="noopener noreferrer sponsored"
          class="amazon-btn"
          data-track-click={trackingId}
        >
          Ver en Amazon ‚Üí
        </a>
      </div>
    )}

    {variant === 'full' && (
      <div class="product-full">
        <div class="product-header">
          <h4>{product.name}</h4>
          <div class="rating">
            {'‚≠ê'.repeat(Math.floor(product.rating))} {product.rating}/5
          </div>
        </div>
        
        <div class="product-grid">
          <div class="specs">
            <p class="price-large">{product.price}</p>
            <ul class="features">
              {product.features.map((f: string) => (
                <li>‚úì {f}</li>
              ))}
            </ul>
            <p class="best-for"><strong>Mejor para:</strong> {product.bestFor}</p>
          </div>
          
          <div class="cta-section">
            <a 
              href={amazonUrl} 
              target="_blank" 
              rel="noopener noreferrer sponsored"
              class="amazon-btn primary"
              data-track-click={trackingId}
            >
              üõí Ver en Amazon
            </a>
            <p class="small-disclaimer">
              Precio y disponibilidad sujetos a cambios
            </p>
          </div>
        </div>
      </div>
    )}
  </div>
)}

<style>
  .amazon-affiliate {
    margin: 2rem 0;
  }

  /* Bot√≥n simple */
  .amazon-btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #FF9900 0%, #FF7A00 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
  }

  .amazon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 153, 0, 0.4);
  }

  .amazon-btn.primary {
    padding: 1rem 2rem;
    font-size: 1.1rem;
  }

  /* Card */
  .product-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  .product-header h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1.15rem;
    color: rgb(var(--black));
  }

  .rating {
    color: #FF9900;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .price {
    font-size: 1.5rem;
    font-weight: 800;
    color: #B12704;
    margin: 0.75rem 0;
  }

  /* Full variant */
  .product-full {
    background: linear-gradient(135deg, rgba(255,153,0,0.05) 0%, rgba(255,122,0,0.05) 100%);
    border: 2px solid #FF9900;
    border-radius: 16px;
    padding: 2rem;
    margin: 2.5rem 0;
  }

  .product-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-top: 1rem;
  }

  @media (min-width: 768px) {
    .product-grid {
      grid-template-columns: 2fr 1fr;
    }
  }

  .price-large {
    font-size: 2rem;
    font-weight: 800;
    color: #B12704;
    margin: 0 0 1rem 0;
  }

  .features {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
  }

  .features li {
    padding: 0.4rem 0;
    color: rgb(var(--gray-dark));
  }

  .best-for {
    color: rgb(var(--gray));
    font-size: 0.95rem;
    margin: 0;
  }

  .cta-section {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .small-disclaimer {
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: rgb(var(--gray));
    text-align: center;
  }
</style>

<script>
  // Tracking de clicks en afiliados
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const link = target.closest('[data-track-click]') as HTMLAnchorElement;
    
    if (link) {
      const trackingId = link.dataset.trackClick;
      
      // Enviar a analytics
      fetch('/api/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          event: 'affiliate_click',
          data: {
            productId: trackingId,
            url: link.href,
            timestamp: new Date().toISOString(),
          }
        })
      }).catch(err => console.warn('Analytics error:', err));

      console.log('üìä Affiliate click:', trackingId);
    }
  });
</script>
