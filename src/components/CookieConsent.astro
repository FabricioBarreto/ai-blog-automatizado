---
const policyLinks = {
  cookies: "/cookies",
  privacy: "/privacy",
};
---

<style>
  .cc-wrap {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  @keyframes slideUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  .cc-card {
    background: #ffffff;
    border-top: 3px solid #2563eb;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.12);
    padding: 1.5rem;
  }
  
  .cc-container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    gap: 1.25rem;
  }
  
  .cc-header {
    display: flex;
    align-items: start;
    gap: 1rem;
  }
  
  .cc-icon {
    font-size: 2rem;
    flex-shrink: 0;
    line-height: 1;
  }
  
  .cc-content {
    flex: 1;
  }
  
  .cc-title { 
    font-weight: 700; 
    font-size: 1.125rem; 
    color: #111827; 
    margin: 0 0 0.5rem;
    line-height: 1.3;
  }
  
  .cc-text { 
    color: #4b5563; 
    line-height: 1.6; 
    margin: 0; 
    font-size: 0.9375rem;
  }
  
  .cc-text strong {
    color: #1f2937;
    font-weight: 600;
  }
  
  .cc-links {
    display: inline-flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }
  
  .cc-links a { 
    color: #2563eb;
    font-weight: 600;
    text-decoration: underline;
    font-size: 0.9375rem;
  }
  
  .cc-links a:hover { 
    color: #1d4ed8;
  }
  
  .cc-links a:focus-visible {
    outline: 2px solid #2563eb;
    outline-offset: 2px;
    border-radius: 2px;
  }

  .cc-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }
  
  .cc-btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    flex: 1;
  }
  
  .cc-btn {
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    font-size: 0.9375rem;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    min-width: 120px;
    text-align: center;
  }
  
  /* Paridad de botones: TODOS los botones principales tienen el mismo peso visual */
  .cc-btn.accept {
    background: #2563eb;
    color: #ffffff;
    border-color: #2563eb;
  }
  
  .cc-btn.accept:hover {
    background: #1d4ed8;
    border-color: #1d4ed8;
    transform: translateY(-1px);
  }
  
  .cc-btn.reject {
    background: #ffffff;
    color: #111827;
    border-color: #d1d5db;
  }
  
  .cc-btn.reject:hover {
    background: #f9fafb;
    border-color: #9ca3af;
    transform: translateY(-1px);
  }
  
  .cc-btn.customize {
    background: #ffffff;
    color: #111827;
    border-color: #d1d5db;
  }
  
  .cc-btn.customize:hover {
    background: #f9fafb;
    border-color: #9ca3af;
    transform: translateY(-1px);
  }
  
  .cc-btn:focus-visible {
    outline: 3px solid #2563eb;
    outline-offset: 2px;
  }
  
  .cc-btn:active {
    transform: scale(0.98);
  }
  
  .cc-settings-link {
    color: #6b7280;
    font-size: 0.875rem;
    background: none;
    border: none;
    cursor: pointer;
    text-decoration: underline;
    padding: 0;
    font-weight: 500;
  }
  
  .cc-settings-link:hover {
    color: #2563eb;
  }

  /* Modal */
  .cc-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 10000;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    padding: 1rem;
    animation: fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .cc-modal.open { 
    display: grid; 
    place-items: center; 
  }
  
  .cc-modal-card {
    width: min(600px, 100%);
    max-height: 90vh;
    overflow-y: auto;
    background: #ffffff;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  @keyframes scaleIn {
    from {
      transform: scale(0.95);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
  
  .cc-modal-header {
    margin-bottom: 1.5rem;
  }
  
  .cc-modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.5rem;
  }
  
  .cc-modal-subtitle {
    color: #6b7280;
    font-size: 0.9375rem;
    margin: 0;
  }
  
  .cc-preference-item {
    display: flex;
    justify-content: space-between;
    align-items: start;
    gap: 1.5rem;
    padding: 1.25rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.2s;
  }
  
  .cc-preference-item:hover {
    border-color: #d1d5db;
    background: #f9fafb;
  }
  
  .cc-preference-item.disabled {
    background: #f3f4f6;
    border-color: #e5e7eb;
  }
  
  .cc-preference-info h4 {
    margin: 0 0 0.25rem;
    color: #111827;
    font-weight: 600;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .cc-preference-info p {
    margin: 0;
    color: #6b7280;
    font-size: 0.875rem;
    line-height: 1.5;
  }
  
  .cc-toggle-wrapper {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }
  
  .cc-toggle {
    position: relative;
    width: 48px;
    height: 28px;
    cursor: pointer;
  }
  
  .cc-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .cc-toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: #d1d5db;
    border-radius: 34px;
    transition: 0.3s;
  }
  
  .cc-toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background: white;
    border-radius: 50%;
    transition: 0.3s;
  }
  
  .cc-toggle input:checked + .cc-toggle-slider {
    background: #2563eb;
  }
  
  .cc-toggle input:checked + .cc-toggle-slider:before {
    transform: translateX(20px);
  }
  
  .cc-toggle input:disabled + .cc-toggle-slider {
    background: #9ca3af;
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  .cc-toggle input:focus-visible + .cc-toggle-slider {
    outline: 3px solid #2563eb;
    outline-offset: 2px;
  }
  
  .cc-toggle-label {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
  }
  
  .cc-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
    flex-wrap: wrap;
  }

  @media (max-width: 768px) {
    .cc-card {
      padding: 1.25rem;
    }
    
    .cc-actions {
      flex-direction: column;
      align-items: stretch;
    }
    
    .cc-btn-group {
      flex-direction: column;
      width: 100%;
    }
    
    .cc-btn {
      width: 100%;
    }
    
    .cc-settings-link {
      text-align: center;
      padding: 0.5rem;
    }
    
    .cc-modal-card {
      padding: 1.5rem;
    }
    
    .cc-preference-item {
      flex-direction: column;
      gap: 1rem;
    }
    
    .cc-toggle-wrapper {
      align-self: flex-start;
      flex-direction: row;
      gap: 0.75rem;
    }
  }
  
  @media (prefers-reduced-motion: reduce) {
    .cc-wrap,
    .cc-modal,
    .cc-modal-card,
    .cc-btn,
    .cc-toggle-slider,
    .cc-toggle-slider:before {
      animation: none;
      transition: none;
    }
  }
</style>

<div class="cc-wrap" id="cc-wrap" hidden>
  <div class="cc-card" role="dialog" aria-live="polite" aria-labelledby="cc-title">
    <div class="cc-container">
      <div class="cc-header">
        <span class="cc-icon" aria-hidden="true">üç™</span>
        <div class="cc-content">
          <h2 class="cc-title" id="cc-title">Usamos cookies en este sitio</h2>
          <p class="cc-text">
            Utilizamos cookies <strong>esenciales</strong> para el funcionamiento del sitio y, con tu consentimiento, 
            cookies de <strong>anal√≠tica</strong> (Google Analytics) y <strong>publicidad</strong> (AdSense) 
            para mejorar tu experiencia.
          </p>
          <div class="cc-links">
            <a href={policyLinks.cookies}>Pol√≠tica de cookies</a>
            <a href={policyLinks.privacy}>Privacidad</a>
          </div>
        </div>
      </div>

      <div class="cc-actions">
        <div class="cc-btn-group">
          <button class="cc-btn accept" id="cc-accept-all" type="button">
            Aceptar todo
          </button>
          <button class="cc-btn reject" id="cc-reject-all" type="button">
            Rechazar opcional
          </button>
          <button class="cc-btn customize" id="cc-customize" type="button">
            Personalizar
          </button>
        </div>
        <button class="cc-settings-link" id="cc-open-settings" type="button">
          Cambiar preferencias
        </button>
      </div>
    </div>
  </div>
</div>

<div class="cc-modal" id="cc-modal" aria-hidden="true">
  <div class="cc-modal-card" role="dialog" aria-labelledby="cc-modal-title">
    <div class="cc-modal-header">
      <h2 class="cc-modal-title" id="cc-modal-title">Preferencias de cookies</h2>
      <p class="cc-modal-subtitle">
        Gestiona tus preferencias de cookies. Las cookies esenciales siempre est√°n activas.
      </p>
    </div>

    <div class="cc-preference-item disabled">
      <div class="cc-preference-info">
        <h4>
          <span aria-hidden="true">‚úì</span>
          Cookies esenciales
        </h4>
        <p>
          Necesarias para el funcionamiento b√°sico del sitio, seguridad y gesti√≥n de sesiones. 
          No se pueden desactivar.
        </p>
      </div>
      <div class="cc-toggle-wrapper">
        <label class="cc-toggle">
          <input 
            type="checkbox" 
            checked 
            disabled 
            aria-label="Cookies esenciales - siempre activas"
          />
          <span class="cc-toggle-slider"></span>
        </label>
        <span class="cc-toggle-label">Siempre</span>
      </div>
    </div>

    <div class="cc-preference-item">
      <div class="cc-preference-info">
        <h4>
          <span aria-hidden="true">üìä</span>
          Cookies de anal√≠tica
        </h4>
        <p>
          Nos ayudan a entender c√≥mo los visitantes interact√∫an con el sitio web 
          recopilando informaci√≥n de manera an√≥nima.
        </p>
      </div>
      <div class="cc-toggle-wrapper">
        <label class="cc-toggle">
          <input 
            type="checkbox" 
            id="cc-analytics" 
            aria-label="Permitir cookies de anal√≠tica"
          />
          <span class="cc-toggle-slider"></span>
        </label>
        <span class="cc-toggle-label" id="cc-analytics-label"></span>
      </div>
    </div>

    <div class="cc-preference-item">
      <div class="cc-preference-info">
        <h4>
          <span aria-hidden="true">üéØ</span>
          Cookies de publicidad
        </h4>
        <p>
          Utilizadas para mostrarte anuncios relevantes basados en tus intereses 
          cuando AdSense est√© activo.
        </p>
      </div>
      <div class="cc-toggle-wrapper">
        <label class="cc-toggle">
          <input 
            type="checkbox" 
            id="cc-ads" 
            aria-label="Permitir cookies de publicidad"
          />
          <span class="cc-toggle-slider"></span>
        </label>
        <span class="cc-toggle-label" id="cc-ads-label"></span>
      </div>
    </div>

    <div class="cc-modal-actions">
      <button class="cc-btn reject" id="cc-cancel" type="button">
        Cancelar
      </button>
      <button class="cc-btn accept" id="cc-save" type="button">
        Guardar preferencias
      </button>
    </div>
  </div>
</div>

<script is:inline>
  const KEY = 'cookie_consent_v1';

  function readConsent() {
    try { 
      const item = localStorage.getItem(KEY);
      return item ? JSON.parse(item) : null;
    } catch { 
      return null; 
    }
  }

  function writeConsent(consent) {
    try {
      localStorage.setItem(KEY, JSON.stringify({
        necessary: true,
        analytics: !!consent.analytics,
        ads: !!consent.ads,
        updatedAt: new Date().toISOString()
      }));
    } catch (e) {
      console.error('Error guardando consentimiento:', e);
    }
  }

  function applyGtagConsent(consent) {
    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }

    if (!window.__consentDefaultSet) {
      window.__consentDefaultSet = true;
      gtag('consent', 'default', {
        ad_storage: 'denied',
        analytics_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        functionality_storage: 'granted',
        security_storage: 'granted'
      });
    }

    gtag('consent', 'update', {
      ad_storage: consent.ads ? 'granted' : 'denied',
      analytics_storage: consent.analytics ? 'granted' : 'denied',
      ad_user_data: consent.ads ? 'granted' : 'denied',
      ad_personalization: consent.ads ? 'granted' : 'denied',
      functionality_storage: 'granted',
      security_storage: 'granted'
    });
  }

  function loadGA() {
    if (window.__gaLoaded) return;
    const id = window.__GA_ID;
    if (!id) return;

    window.__gaLoaded = true;
    const s = document.createElement('script');
    s.async = true;
    s.src = `https://www.googletagmanager.com/gtag/js?id=${id}`;
    document.head.appendChild(s);

    window.dataLayer = window.dataLayer || [];
    function gtag(){ window.dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', id, { anonymize_ip: true });
  }

  function loadAdsense() {
    if (window.__adsenseLoaded) return;
    const adsenseId = window.__ADSENSE_ID;
    if (!adsenseId) return;

    window.__adsenseLoaded = true;
    const s = document.createElement('script');
    s.async = true;
    s.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${adsenseId}`;
    s.crossOrigin = 'anonymous';
    document.head.appendChild(s);
  }

  function enforce(consent) {
    applyGtagConsent(consent);
    if (consent.analytics) loadGA();
    if (consent.ads) loadAdsense();
    window.__CONSENT__ = consent;
  }

  function updateToggleLabels() {
    const analyticsLabel = document.getElementById('cc-analytics-label');
    const adsLabel = document.getElementById('cc-ads-label');
    const analyticsInput = document.getElementById('cc-analytics');
    const adsInput = document.getElementById('cc-ads');
    
    if (analyticsLabel && analyticsInput) {
      analyticsLabel.textContent = analyticsInput.checked ? 'Activo' : 'Inactivo';
    }
    if (adsLabel && adsInput) {
      adsLabel.textContent = adsInput.checked ? 'Activo' : 'Inactivo';
    }
  }

  function showBannerIfNeeded() {
    const wrap = document.getElementById('cc-wrap');
    if (!wrap) return;
    
    const consent = readConsent();
    if (!consent) {
      wrap.hidden = false;
    } else {
      wrap.hidden = true;
      enforce(consent);
    }
  }

  function initCookieBanner() {
    const wrap = document.getElementById('cc-wrap');
    const modal = document.getElementById('cc-modal');
    const btnAccept = document.getElementById('cc-accept-all');
    const btnReject = document.getElementById('cc-reject-all');
    const btnCustomize = document.getElementById('cc-customize');
    const btnOpen = document.getElementById('cc-open-settings');
    const chkAnalytics = document.getElementById('cc-analytics');
    const chkAds = document.getElementById('cc-ads');
    const btnSave = document.getElementById('cc-save');
    const btnCancel = document.getElementById('cc-cancel');

    if (!wrap || !modal) return;

    function openModal() {
      const current = readConsent() || { analytics: false, ads: false };
      if (chkAnalytics) chkAnalytics.checked = !!current.analytics;
      if (chkAds) chkAds.checked = !!current.ads;
      updateToggleLabels();
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    btnAccept?.addEventListener('click', () => {
      const consent = { necessary: true, analytics: true, ads: true };
      writeConsent(consent);
      wrap.hidden = true;
      enforce(consent);
    });

    btnReject?.addEventListener('click', () => {
      const consent = { necessary: true, analytics: false, ads: false };
      writeConsent(consent);
      wrap.hidden = true;
      enforce(consent);
    });

    btnCustomize?.addEventListener('click', openModal);
    btnOpen?.addEventListener('click', openModal);
    btnCancel?.addEventListener('click', closeModal);

    btnSave?.addEventListener('click', () => {
      const consent = { 
        necessary: true, 
        analytics: chkAnalytics?.checked || false, 
        ads: chkAds?.checked || false 
      };
      writeConsent(consent);
      wrap.hidden = true;
      closeModal();
      enforce(consent);
    });

    chkAnalytics?.addEventListener('change', updateToggleLabels);
    chkAds?.addEventListener('change', updateToggleLabels);

    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        closeModal();
      }
    });

    showBannerIfNeeded();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCookieBanner);
  } else {
    initCookieBanner();
  }
</script>