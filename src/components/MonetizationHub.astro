---
interface Props {
  postTitle: string;
  category?: string;
  hasProducts?: boolean; // Si el artÃ­culo tiene productos Amazon
}

const { postTitle, category = 'general', hasProducts = false } = Astro.props;
---

<div class="monetization-section">
  
  <!-- Newsletter (SIEMPRE, es lo menos invasivo) -->
  <div class="newsletter-card">
    <div class="newsletter-header">
      <span class="newsletter-icon">ðŸ“¬</span>
      <div>
        <h3>Â¿Te gustÃ³ este artÃ­culo?</h3>
        <p>RecibÃ­ guÃ­as exclusivas y tips de productividad directo en tu inbox</p>
      </div>
    </div>
    
    <form class="newsletter-form" data-post-title={postTitle}>
      <input
        type="email"
        name="email"
        placeholder="tu@email.com"
        required
      />
      <button type="submit">Suscribirme Gratis</button>
    </form>
    
    <p class="privacy-note">ðŸ”’ Sin spam. CancelÃ¡ cuando quieras.</p>
  </div>

  <!-- SOLO si el artÃ­culo NO tiene productos Amazon -->
  {!hasProducts && (
    <div class="value-add-cta">
      <div class="cta-badge">ðŸ’Ž Recurso Premium</div>
      <h3>GuÃ­a Completa: AutomatizaciÃ³n con IA</h3>
      <p>Aprende a automatizar tu flujo de trabajo con las mejores herramientas de IA.</p>
      <div class="cta-footer">
        <span class="cta-price">Gratis por tiempo limitado</span>
        <a href="/recursos" class="cta-button">
          Descargar GuÃ­a â†’
        </a>
      </div>
    </div>
  )}
</div>

<style>
  .monetization-section {
    max-width: 720px;
    margin: 4rem auto 2rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  /* Newsletter - DiseÃ±o minimalista */
  .newsletter-card {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border: 2px solid #667eea30;
    border-radius: 16px;
    padding: 2rem;
  }

  .newsletter-header {
    display: flex;
    gap: 1rem;
    align-items: start;
    margin-bottom: 1.5rem;
  }

  .newsletter-icon {
    font-size: 2.5rem;
    line-height: 1;
  }

  .newsletter-card h3 {
    margin: 0 0 0.5rem;
    font-size: 1.3rem;
    color: #1e293b;
  }

  .newsletter-card p {
    margin: 0;
    color: #64748b;
    font-size: 0.95rem;
  }

  .newsletter-form {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .newsletter-form input {
    flex: 1;
    min-width: 200px;
    padding: 0.875rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .newsletter-form input:focus {
    outline: none;
    border-color: #667eea;
  }

  .newsletter-form button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.875rem 2rem;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .newsletter-form button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
  }

  .privacy-note {
    margin-top: 0.75rem;
    font-size: 0.85rem;
    color: #64748b;
    text-align: center;
  }

  /* CTA Recurso Premium - Solo si NO hay productos */
  .value-add-cta {
    background: white;
    border: 2px solid #f59e0b;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.15);
  }

  .cta-badge {
    display: inline-block;
    background: #fef3c7;
    color: #92400e;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .value-add-cta h3 {
    margin: 0 0 0.75rem;
    font-size: 1.4rem;
    color: #1e293b;
  }

  .value-add-cta p {
    margin: 0 0 1.5rem;
    color: #64748b;
    line-height: 1.6;
  }

  .cta-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .cta-price {
    font-size: 1.1rem;
    font-weight: 700;
    color: #f59e0b;
  }

  .cta-button {
    background: #1e293b;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 700;
    transition: background 0.2s;
  }

  .cta-button:hover {
    background: #0f172a;
  }

  @media (max-width: 640px) {
    .monetization-section {
      margin: 3rem auto 1.5rem;
    }

    .newsletter-card {
      padding: 1.5rem;
    }

    .newsletter-form {
      flex-direction: column;
    }

    .newsletter-form input {
      width: 100%;
    }

    .cta-footer {
      flex-direction: column;
      align-items: stretch;
    }

    .cta-button {
      text-align: center;
    }
  }
</style>

<script>
  // Declare gtag on window object
  declare global {
    interface Window {
      gtag?: (command: string, eventName: string, eventParams?: Record<string, unknown>) => void;
    }
  }

  // Newsletter submission
  document.querySelectorAll('.newsletter-form').forEach((form) => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formElement = e.target as HTMLFormElement;
      const input = formElement.querySelector('input[name="email"]') as HTMLInputElement;
      const button = formElement.querySelector('button') as HTMLButtonElement;
      const email = input?.value;

      if (!email) return;

      const originalText = button.textContent;
      button.textContent = 'Suscribiendo...';
      button.disabled = true;

      try {
        const response = await fetch('/api/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            source: formElement.dataset.postTitle,
          }),
        });

        if (response.ok) {
          // Track en Google Analytics
          if (window.gtag) {
            window.gtag('event', 'newsletter_signup', {
              event_category: 'engagement',
              event_label: formElement.dataset.postTitle,
            });
          }

          button.textContent = 'âœ… Â¡Listo! Revisa tu email';
          button.style.background = '#10b981';
          input.value = '';
        } else {
          throw new Error('Signup failed');
        }
      } catch (error) {
        button.textContent = 'âŒ Error, intenta de nuevo';
        button.style.background = '#ef4444';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
          button.disabled = false;
        }, 3000);
      }
    });
  });
</script>