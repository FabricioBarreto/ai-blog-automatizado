# .github/workflows/auto-content-pipeline.yml
# Pipeline automatizado: Research to Generate to Publish to Monitor

name: ü§ñ Automated Content Pipeline

on:
  # Trigger manual
  workflow_dispatch:
    inputs:
      keyword:
        description: "Keyword espec√≠fico (opcional)"
        required: false
        type: string
      quantity:
        description: "Cantidad de art√≠culos"
        required: false
        default: "1"
        type: choice
        options:
          - "1"
          - "3"
          - "5"

  # Automatizado: 2x por semana
  schedule:
    - cron: "0 10 * * 1,4" # Lunes y Jueves 10 AM UTC

  # Cuando pusheas cambios a config
  push:
    paths:
      - "config/monetization.config.ts"
      - "config/keywords.json"

jobs:
  generate-content:
    runs-on: ubuntu-latest

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
      SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
      AMAZON_API_KEY: ${{ secrets.AMAZON_API_KEY }}

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üîç Cargar keywords desde config
        id: load-keywords
        run: |
          # Si no hay keyword manual, usar del pool
          if [ -z "${{ github.event.inputs.keyword }}" ]; then
            # Leer de config/keywords.json (lista rotativa)
            KEYWORD=$(node -e "
              const fs = require('fs');
              const keywords = JSON.parse(fs.readFileSync('config/keywords.json'));
              const used = keywords.used || [];
              const available = keywords.pool.filter(k => !used.includes(k));
              
              if (available.length === 0) {
                // Reset si ya usamos todos
                fs.writeFileSync('config/keywords.json', JSON.stringify({
                  ...keywords,
                  used: []
                }, null, 2));
                console.log(keywords.pool[0]);
              } else {
                const selected = available[Math.floor(Math.random() * available.length)];
                console.log(selected);
              }
            ")
            echo "keyword=${KEYWORD}" >> $GITHUB_OUTPUT
          else
            echo "keyword=${{ github.event.inputs.keyword }}" >> $GITHUB_OUTPUT
          fi

      - name: üìù Generar art√≠culo(s)
        env:
          CUSTOM_KEYWORD: ${{ steps.load-keywords.outputs.keyword }}
        run: |
          QUANTITY=${{ github.event.inputs.quantity || '1' }}

          for i in $(seq 1 $QUANTITY); do
            echo "üöÄ Generando art√≠culo $i/$QUANTITY..."
            node scripts/generate-smart-article.js
            
            # Esperar entre generaciones para evitar rate limits
            if [ $i -lt $QUANTITY ]; then
              sleep 30
            fi
          done

      - name: üîÑ Marcar keyword como usado
        if: success()
        run: |
          node -e "
            const fs = require('fs');
            const keywords = JSON.parse(fs.readFileSync('config/keywords.json'));
            const used = keywords.used || [];
            used.push('${{ steps.load-keywords.outputs.keyword }}');
            
            fs.writeFileSync('config/keywords.json', JSON.stringify({
              ...keywords,
              used
            }, null, 2));
          "

      - name: üèóÔ∏è Build site
        run: npm run build

      - name: ‚úÖ Commit & Push
        run: |
          git config user.name "Content Bot"
          git config user.email "bot@yourdomain.com"

          git add src/content/blog/*.md
          git add config/keywords.json
          git add public/images/*.jpg

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ü§ñ Auto: New article(s) for '${{ steps.load-keywords.outputs.keyword }}'"
            git push
          fi

      - name: üöÄ Deploy to Vercel (opcional)
        if: success()
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"

      - name: üìä Report summary
        if: always()
        run: |
          echo "## ü§ñ Content Pipeline Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Keyword:** ${{ steps.load-keywords.outputs.keyword }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Art√≠culos generados:** ${{ github.event.inputs.quantity || '1' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # Job separado: Optimizaci√≥n de im√°genes
  optimize-images:
    needs: generate-content
    runs-on: ubuntu-latest
    if: success()

    steps:
      - uses: actions/checkout@v4

      - name: üñºÔ∏è Optimizar im√°genes con Sharp
        run: |
          npm ci
          node scripts/optimize-images.js

      - name: ‚úÖ Commit optimized images
        run: |
          git config user.name "Image Bot"
          git config user.email "bot@yourdomain.com"

          git add public/images/*.jpg
          git diff --staged --quiet || git commit -m "üñºÔ∏è Optimized images"
          git push

  # Job separado: Notificaci√≥n de √©xito
  notify:
    needs: [generate-content, optimize-images]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: üí¨ Notificar en Discord/Slack
        if: success()
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "‚úÖ **Nuevo contenido publicado**\n- Keyword: ${{ steps.load-keywords.outputs.keyword }}\n- Art√≠culos: ${{ github.event.inputs.quantity || 1 }}\n- Ver: https://yourdomain.com/blog"
            }'
